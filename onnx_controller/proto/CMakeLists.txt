INCLUDE(FindProtobuf)
FIND_PACKAGE(Protobuf 3 REQUIRED)
INCLUDE_DIRECTORIES(${PROTOBUF_INCLUDE_DIR} ${Protobuf_INCLUDE_DIRS})

FILE(GLOB all_protos "*.proto")

FOREACH(f ${all_protos})
	FILE(RELATIVE_PATH f ${CMAKE_CURRENT_SOURCE_DIR} ${f})
    STRING(REGEX REPLACE "\\.proto$" "" f ${f})
    LIST(APPEND proto_sources "autogenerated/${f}.pb.h")
    LIST(APPEND proto_sources "autogenerated/${f}.pb.cc")
ENDFOREACH(f)

message("proto_sources: ${proto_sources}")

add_custom_command(
    OUTPUT ${proto_sources}
    COMMAND ${CMAKE_COMMAND} -E make_directory autogenerated
    COMMAND ${Protobuf_PROTOC_EXECUTABLE} --proto_path=${CMAKE_CURRENT_SOURCE_DIR} --cpp_out=autogenerated ${all_protos}
)

add_library(mcap_proto_lib ${proto_sources})
target_link_libraries(mcap_proto_lib INTERFACE ${Protobuf_LIBRARIES})
target_include_directories(mcap_proto_lib PUBLIC ${CMAKE_CURRENT_BINARY_DIR}/autogenerated)
